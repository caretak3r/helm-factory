---
# Source: aurora-gateway/templates/app.yaml
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: aurora-gateway
  namespace: aurora-gateway-ns
  labels:
    helm.sh/chart: aurora-gateway-0.5.2
    app.kubernetes.io/name: aurora-gateway
    app.kubernetes.io/instance: aurora-gateway
    app.kubernetes.io/version: "0.5.2"
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/managed-by: "platform-engineering"
    stack: "aurora"
spec:
  podSelector:
    matchLabels:
      app.kubernetes.io/name: aurora-gateway
      app.kubernetes.io/instance: aurora-gateway
  policyTypes:
    - Ingress
    - Egress
  ingress:
    - from:
      - namespaceSelector:
          matchLabels:
            kubernetes.io/metadata.name: ingress-nginx
      ports:
      - port: 8080
        protocol: TCP
  egress:
    - ports:
      - port: 443
        protocol: TCP
      to:
      - namespaceSelector:
          matchLabels:
            kubernetes.io/metadata.name: kube-system
---
# Source: aurora-gateway/templates/app.yaml
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: aurora-gateway
  namespace: aurora-gateway-ns
  labels:
    helm.sh/chart: aurora-gateway-0.5.2
    app.kubernetes.io/name: aurora-gateway
    app.kubernetes.io/instance: aurora-gateway
    app.kubernetes.io/version: "0.5.2"
    app.kubernetes.io/managed-by: Helm
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: aurora-gateway
      app.kubernetes.io/instance: aurora-gateway
  minAvailable: 2
---
# Source: aurora-gateway/templates/app.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: aurora-gateway
  namespace: aurora-gateway-ns
  labels:
    helm.sh/chart: aurora-gateway-0.5.2
    app.kubernetes.io/name: aurora-gateway
    app.kubernetes.io/instance: aurora-gateway
    app.kubernetes.io/version: "0.5.2"
    app.kubernetes.io/managed-by: Helm
  annotations:
    eks.amazonaws.com/role-arn: arn:aws:iam::123456789012:role/aurora-gateway
---
# Source: aurora-gateway/templates/app.yaml
apiVersion: v1
kind: Secret
metadata:
  name: aurora-gateway-secret
  namespace: aurora-gateway-ns
  labels:
    helm.sh/chart: aurora-gateway-0.5.2
    app.kubernetes.io/name: aurora-gateway
    app.kubernetes.io/instance: aurora-gateway
    app.kubernetes.io/version: "0.5.2"
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/managed-by: "platform-engineering"
    stack: "aurora"
  annotations:
    maintainer: "sre@aurora.example"
type: Opaque
stringData:
  API_TOKEN: dev-token
  DATABASE_URL: postgresql://aurora:aurora@aurora-postgres:5432/aurora
  DB_PASSWORD: super-secret-password
---
# Source: aurora-gateway/templates/app.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: aurora-gateway-config
  namespace: aurora-gateway-ns
  labels:
    helm.sh/chart: aurora-gateway-0.5.2
    app.kubernetes.io/name: aurora-gateway
    app.kubernetes.io/instance: aurora-gateway
    app.kubernetes.io/version: "0.5.2"
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/managed-by: "platform-engineering"
    stack: "aurora"
  annotations:
    maintainer: "sre@aurora.example"
data:
  FEATURE_FLAG_ROLLOUT: |
    canary
  application.yaml: |
    server:
      port: 8080
    features:
      asyncPipeline: true
      betaBanner: false
    ---

apiVersion: v1
kind: ConfigMap
metadata:
  name: aurora-gateway-preinstall-script
  namespace: aurora-gateway-ns
  labels:
    helm.sh/chart: aurora-gateway-0.5.2
    app.kubernetes.io/name: aurora-gateway
    app.kubernetes.io/instance: aurora-gateway
    app.kubernetes.io/version: "0.5.2"
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/managed-by: "platform-engineering"
    stack: "aurora"
    workload: gateway
    app.kubernetes.io/component: job-preinstall-script
data:
  script.sh: |
    echo "running schema migrations"
    ./aurora migrate --database $DATABASE_URL
    ---

apiVersion: v1
kind: ConfigMap
metadata:
  name: aurora-gateway-postinstall-script
  namespace: aurora-gateway-ns
  labels:
    helm.sh/chart: aurora-gateway-0.5.2
    app.kubernetes.io/name: aurora-gateway
    app.kubernetes.io/instance: aurora-gateway
    app.kubernetes.io/version: "0.5.2"
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/managed-by: "platform-engineering"
    stack: "aurora"
    workload: gateway
    app.kubernetes.io/component: job-postinstall-script
data:
  script.sh: |
    echo "triggering smoke test"
    ./aurora smoke-test --endpoint $SERVICE_URL
---
# Source: aurora-gateway/templates/app.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: aurora-gateway-service-endpoints
  namespace: aurora-gateway-ns
  labels:
    helm.sh/chart: aurora-gateway-0.5.2
    app.kubernetes.io/name: aurora-gateway
    app.kubernetes.io/instance: aurora-gateway
    app.kubernetes.io/version: "0.5.2"
    app.kubernetes.io/managed-by: Helm
data:
  # List of enabled subcharts
  enabled-subcharts: |
    affinity,annotations,autoscaling,certificate,commonAnnotations,commonLabels,configMap,containerSecurityContext,cronJob,daemonSet,envVars,frontend,highAvailability,image,ingress,initContainers,jobs,labels,lifecycleHooks,livenessProbe,mtls,networkPolicy,nodeSelector,persistence,pipeline,platform,podAnnotations,podDisruptionBudget,podLabels,podSecurityContext,readinessProbe,resources,secret,service,serviceAccount,serviceMonitor,sidecars,startupProbe,statefulSet,updateStrategy,workload

  # Dynamically generate all enabled service endpoints
  affinity-endpoint: "affinity.aurora-gateway-ns.svc.cluster.local:80"
  annotations-endpoint: "annotations.aurora-gateway-ns.svc.cluster.local:80"
  autoscaling-endpoint: "autoscaling.aurora-gateway-ns.svc.cluster.local:80"
  certificate-endpoint: "certificate.aurora-gateway-ns.svc.cluster.local:80"
  commonAnnotations-endpoint: "commonAnnotations.aurora-gateway-ns.svc.cluster.local:80"
  commonLabels-endpoint: "commonLabels.aurora-gateway-ns.svc.cluster.local:80"
  configMap-endpoint: "configMap.aurora-gateway-ns.svc.cluster.local:80"
  containerSecurityContext-endpoint: "containerSecurityContext.aurora-gateway-ns.svc.cluster.local:80"
  cronJob-endpoint: "cronJob.aurora-gateway-ns.svc.cluster.local:80"
  daemonSet-endpoint: "daemonSet.aurora-gateway-ns.svc.cluster.local:80"
  envVars-endpoint: "envVars.aurora-gateway-ns.svc.cluster.local:80"
  frontend-endpoint: "frontend.aurora-gateway-ns.svc.cluster.local:80"
  highAvailability-endpoint: "highAvailability.aurora-gateway-ns.svc.cluster.local:80"
  image-endpoint: "image.aurora-gateway-ns.svc.cluster.local:80"
  ingress-endpoint: "ingress.aurora-gateway-ns.svc.cluster.local:80"
  initContainers-endpoint: "initContainers.aurora-gateway-ns.svc.cluster.local:80"
  jobs-endpoint: "jobs.aurora-gateway-ns.svc.cluster.local:80"
  labels-endpoint: "labels.aurora-gateway-ns.svc.cluster.local:80"
  lifecycleHooks-endpoint: "lifecycleHooks.aurora-gateway-ns.svc.cluster.local:80"
  livenessProbe-endpoint: "livenessProbe.aurora-gateway-ns.svc.cluster.local:80"
  mtls-endpoint: "mtls.aurora-gateway-ns.svc.cluster.local:80"
  networkPolicy-endpoint: "networkPolicy.aurora-gateway-ns.svc.cluster.local:80"
  nodeSelector-endpoint: "nodeSelector.aurora-gateway-ns.svc.cluster.local:80"
  persistence-endpoint: "persistence.aurora-gateway-ns.svc.cluster.local:80"
  pipeline-endpoint: "pipeline.aurora-gateway-ns.svc.cluster.local:80"
  platform-endpoint: "platform.aurora-gateway-ns.svc.cluster.local:80"
  podAnnotations-endpoint: "podAnnotations.aurora-gateway-ns.svc.cluster.local:80"
  podDisruptionBudget-endpoint: "podDisruptionBudget.aurora-gateway-ns.svc.cluster.local:80"
  podLabels-endpoint: "podLabels.aurora-gateway-ns.svc.cluster.local:80"
  podSecurityContext-endpoint: "podSecurityContext.aurora-gateway-ns.svc.cluster.local:80"
  readinessProbe-endpoint: "readinessProbe.aurora-gateway-ns.svc.cluster.local:80"
  resources-endpoint: "resources.aurora-gateway-ns.svc.cluster.local:80"
  secret-endpoint: "secret.aurora-gateway-ns.svc.cluster.local:80"
  service-endpoint: "service.aurora-gateway-ns.svc.cluster.local:80"
  serviceAccount-endpoint: "serviceAccount.aurora-gateway-ns.svc.cluster.local:80"
  serviceMonitor-endpoint: "serviceMonitor.aurora-gateway-ns.svc.cluster.local:80"
  sidecars-endpoint: "sidecars.aurora-gateway-ns.svc.cluster.local:80"
  startupProbe-endpoint: "startupProbe.aurora-gateway-ns.svc.cluster.local:80"
  statefulSet-endpoint: "statefulSet.aurora-gateway-ns.svc.cluster.local:80"
  updateStrategy-endpoint: "updateStrategy.aurora-gateway-ns.svc.cluster.local:80"
  workload-endpoint: "workload.aurora-gateway-ns.svc.cluster.local:80"

  # All endpoints as structured data
  service-endpoints.yaml: |
    affinity: affinity.aurora-gateway-ns.svc.cluster.local:80
    annotations: annotations.aurora-gateway-ns.svc.cluster.local:80
    autoscaling: autoscaling.aurora-gateway-ns.svc.cluster.local:80
    certificate: certificate.aurora-gateway-ns.svc.cluster.local:80
    commonAnnotations: commonAnnotations.aurora-gateway-ns.svc.cluster.local:80
    commonLabels: commonLabels.aurora-gateway-ns.svc.cluster.local:80
    configMap: configMap.aurora-gateway-ns.svc.cluster.local:80
    containerSecurityContext: containerSecurityContext.aurora-gateway-ns.svc.cluster.local:80
    cronJob: cronJob.aurora-gateway-ns.svc.cluster.local:80
    daemonSet: daemonSet.aurora-gateway-ns.svc.cluster.local:80
    envVars: envVars.aurora-gateway-ns.svc.cluster.local:80
    frontend: frontend.aurora-gateway-ns.svc.cluster.local:80
    highAvailability: highAvailability.aurora-gateway-ns.svc.cluster.local:80
    image: image.aurora-gateway-ns.svc.cluster.local:80
    ingress: ingress.aurora-gateway-ns.svc.cluster.local:80
    initContainers: initContainers.aurora-gateway-ns.svc.cluster.local:80
    jobs: jobs.aurora-gateway-ns.svc.cluster.local:80
    labels: labels.aurora-gateway-ns.svc.cluster.local:80
    lifecycleHooks: lifecycleHooks.aurora-gateway-ns.svc.cluster.local:80
    livenessProbe: livenessProbe.aurora-gateway-ns.svc.cluster.local:80
    mtls: mtls.aurora-gateway-ns.svc.cluster.local:80
    networkPolicy: networkPolicy.aurora-gateway-ns.svc.cluster.local:80
    nodeSelector: nodeSelector.aurora-gateway-ns.svc.cluster.local:80
    persistence: persistence.aurora-gateway-ns.svc.cluster.local:80
    pipeline: pipeline.aurora-gateway-ns.svc.cluster.local:80
    platform: platform.aurora-gateway-ns.svc.cluster.local:80
    podAnnotations: podAnnotations.aurora-gateway-ns.svc.cluster.local:80
    podDisruptionBudget: podDisruptionBudget.aurora-gateway-ns.svc.cluster.local:80
    podLabels: podLabels.aurora-gateway-ns.svc.cluster.local:80
    podSecurityContext: podSecurityContext.aurora-gateway-ns.svc.cluster.local:80
    readinessProbe: readinessProbe.aurora-gateway-ns.svc.cluster.local:80
    resources: resources.aurora-gateway-ns.svc.cluster.local:80
    secret: secret.aurora-gateway-ns.svc.cluster.local:80
    service: service.aurora-gateway-ns.svc.cluster.local:80
    serviceAccount: serviceAccount.aurora-gateway-ns.svc.cluster.local:80
    serviceMonitor: serviceMonitor.aurora-gateway-ns.svc.cluster.local:80
    sidecars: sidecars.aurora-gateway-ns.svc.cluster.local:80
    startupProbe: startupProbe.aurora-gateway-ns.svc.cluster.local:80
    statefulSet: statefulSet.aurora-gateway-ns.svc.cluster.local:80
    updateStrategy: updateStrategy.aurora-gateway-ns.svc.cluster.local:80
    workload: workload.aurora-gateway-ns.svc.cluster.local:80
---
# Source: aurora-gateway/templates/app.yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: aurora-gateway-data
  namespace: aurora-gateway-ns
  labels:
    helm.sh/chart: aurora-gateway-0.5.2
    app.kubernetes.io/name: aurora-gateway
    app.kubernetes.io/instance: aurora-gateway
    app.kubernetes.io/version: "0.5.2"
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/managed-by: "platform-engineering"
    stack: "aurora"
  annotations:
    maintainer: "sre@aurora.example"
    snapshot.storage.kubernetes.io/retain: "true"
spec:
  accessModes:
    - "ReadWriteOnce"
  resources:
    requests:
      storage: "50Gi"
  storageClassName: "fast-ssd"
---
# Source: aurora-gateway/templates/app.yaml
apiVersion: v1
kind: Service
metadata:
  name: aurora-gateway
  namespace: aurora-gateway-ns
  labels:
    helm.sh/chart: aurora-gateway-0.5.2
    app.kubernetes.io/name: aurora-gateway
    app.kubernetes.io/instance: aurora-gateway
    app.kubernetes.io/version: "0.5.2"
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/managed-by: "platform-engineering"
    stack: "aurora"
  annotations:
    maintainer: "sre@aurora.example"
    service.beta.kubernetes.io/aws-load-balancer-type: "nlb"
spec:
  type: LoadBalancer
  sessionAffinity: ClientIP
  sessionAffinityConfig:
    clientIP:
      timeoutSeconds: 10800
  loadBalancerSourceRanges:
    - 10.0.0.0/24
  externalTrafficPolicy: Local
  ports:
    - name: http
      port: 80
      protocol: TCP
      targetPort: http
    - name: grpc
      port: 9090
      protocol: TCP
      targetPort: grpc
  selector:
    app.kubernetes.io/name: aurora-gateway
    app.kubernetes.io/instance: aurora-gateway
    app.kubernetes.io/managed-by: "platform-engineering"
    stack: "aurora"
---
# Source: aurora-gateway/templates/frontend.yaml
apiVersion: v1
kind: Service
metadata:
  name: aurora-gateway-frontend-svc
  labels:
    app.kubernetes.io/component: frontend
    app.kubernetes.io/instance: aurora-gateway
    app.kubernetes.io/name: aurora-gateway-frontend
  annotations:
    cloud.google.com/backend-config: '{"default":"aurora-frontend"}'
spec:
  type: ClusterIP
  selector:
    app.kubernetes.io/component: frontend
    app.kubernetes.io/instance: aurora-gateway
    app.kubernetes.io/name: aurora-gateway-frontend
  ports:
    - name: web
      port: 80
      targetPort: web
      protocol: TCP
---
# Source: aurora-gateway/templates/frontend.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: aurora-gateway-frontend
  labels:
    app.kubernetes.io/component: frontend
    app.kubernetes.io/instance: aurora-gateway
    app.kubernetes.io/name: aurora-gateway-frontend
    app.kubernetes.io/part-of: aurora-gateway
  annotations:
    rollout/version: blue
spec:
  replicas: 3
  selector:
    matchLabels:
      app.kubernetes.io/component: frontend
      app.kubernetes.io/instance: aurora-gateway
      app.kubernetes.io/name: aurora-gateway-frontend
  template:
    metadata:
      labels:
        app.kubernetes.io/component: frontend
        app.kubernetes.io/instance: aurora-gateway
        app.kubernetes.io/name: aurora-gateway-frontend
        tier: "presentation"
      annotations:
        prometheus.io/port: "4173"
        prometheus.io/scrape: "true"
    spec:
      serviceAccountName: aurora-gateway
      containers:
        - name: frontend
          image: ghcr.io/caretak3r/aurora-frontend:2.4.1
          imagePullPolicy: IfNotPresent
          ports:
            - name: web
              containerPort: 4173
              protocol: TCP
          env:
            - name: API_BASE_URL
              value: https://aurora.localdev.me/api
            - name: FEATURE_TOGGLE
              value: neon
          resources:
            limits:
              cpu: 500m
              memory: 1Gi
            requests:
              cpu: 250m
              memory: 512Mi
      nodeSelector:
        kubernetes.io/os: linux
      tolerations:
        - effect: NoSchedule
          key: dedicated
          operator: Equal
          value: frontend
---
# Source: aurora-gateway/templates/app.yaml
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: aurora-gateway
  namespace: aurora-gateway-ns
  labels:
    helm.sh/chart: aurora-gateway-0.5.2
    app.kubernetes.io/name: aurora-gateway
    app.kubernetes.io/instance: aurora-gateway
    app.kubernetes.io/version: "0.5.2"
    app.kubernetes.io/managed-by: Helm
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: StatefulSet
    name: aurora-gateway
  minReplicas: 3
  maxReplicas: 9
  behavior:
    scaleDown:
      policies:
      - periodSeconds: 60
        type: Percent
        value: 20
      stabilizationWindowSeconds: 300
    scaleUp:
      policies:
      - periodSeconds: 30
        type: Percent
        value: 100
      stabilizationWindowSeconds: 0
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 65
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 70
---
# Source: aurora-gateway/templates/app.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: aurora-gateway
  namespace: aurora-gateway-ns
  labels:
    helm.sh/chart: aurora-gateway-0.5.2
    app.kubernetes.io/name: aurora-gateway
    app.kubernetes.io/instance: aurora-gateway
    app.kubernetes.io/version: "0.5.2"
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/managed-by: "platform-engineering"
    stack: "aurora"
    workload: "gateway"
  annotations:
    maintainer: "sre@aurora.example"
    reloader.stakater.com/auto: "true"
spec:
  serviceName: aurora-gateway-headless
  podManagementPolicy: OrderedReady
  updateStrategy:
    rollingUpdate:
      partition: 0
    type: RollingUpdate
  selector:
    matchLabels:
      app.kubernetes.io/name: aurora-gateway
      app.kubernetes.io/instance: aurora-gateway
  template:
    metadata:
      labels:
        app.kubernetes.io/name: aurora-gateway
        app.kubernetes.io/instance: aurora-gateway
        app.kubernetes.io/managed-by: "platform-engineering"
        stack: "aurora"
        trace-enabled: "true"
      annotations:
        maintainer: "sre@aurora.example"
        sidecar.istio.io/inject: "true"
    spec:
      serviceAccountName: aurora-gateway
      imagePullSecrets:
        - name: ghcr-creds
        - name: ghcr-creds
      securityContext:
        fsGroup: 2000
      initContainers:
        - command:
          - /bin/sh
          - -c
          - until nc -z aurora-postgres 5432; do echo "waiting for db"; sleep 3; done; echo
            "db ready";
          image: busybox:1.36
          name: init-schema
          resources:
            requests:
              cpu: 30m
              memory: 64Mi
      containers:
        - name: aurora-gateway
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
              - ALL
            readOnlyRootFilesystem: true
            runAsNonRoot: true
            runAsUser: 2000
          image: ghcr.io/caretak3r/caretakers/aurora-gateway:1.3.7
    
          imagePullPolicy: IfNotPresent
    
          command:
            - /bin/aurora-gateway
          args:
            - --config=/app/config/application.yaml
            - --enable-ingress-proxy
          env:
            
            - name: CACHE_ENDPOINT
              valueFrom:
                secretKeyRef:
                  key: endpoint
                  name: aurora-cache
            - name: FEATURE_FLAG
              value: "blueGreen"
            - name: LOG_LEVEL
              value: "info"
          envFrom:
            - configMapRef:
                name: aurora-gateway-config
            - secretRef:
                name: aurora-gateway-secret
          ports:
            - containerPort: 8080
              name: http
              protocol: TCP
            - containerPort: 9090
              name: grpc
              protocol: TCP
          livenessProbe:
            failureThreshold: 3
            httpGet:
              path: /healthz
              port: http
            initialDelaySeconds: 30
            periodSeconds: 10
            successThreshold: 1
            timeoutSeconds: 5
          readinessProbe:
            failureThreshold: 3
            httpGet:
              path: /ready
              port: http
            initialDelaySeconds: 10
            periodSeconds: 5
            successThreshold: 1
            timeoutSeconds: 3
          startupProbe:
            failureThreshold: 30
            httpGet:
              path: /healthz
              port: http
            initialDelaySeconds: 0
            periodSeconds: 10
            successThreshold: 1
            timeoutSeconds: 1
          lifecycle:
            preStop:
              exec:
                command:
                - /bin/sh
                - -c
                - sleep 5 && curl -X POST localhost:8080/shutdown
          resources:
            limits:
              cpu: 1500m
              memory: 3Gi
            requests:
              cpu: 500m
              memory: 1Gi
          volumeMounts:
            - mountPath: /app/config
              name: config
              subPath: application.yaml
            - mountPath: /var/lib/aurora
              name: data
            - mountPath: /etc/ssl/certs/custom
              name: ca-bundle
              readOnly: true
        - args:
          - --config=/etc/vector/vector.toml
          image: timberio/vector:0.40.0-debian
          name: vector-agent
          resources:
            requests:
              cpu: 50m
              memory: 128Mi
          volumeMounts:
          - mountPath: /var/log/app
            name: varlog
      volumes:
        - configMap:
            name: aurora-gateway-config
          name: config
        - name: data
          persistentVolumeClaim:
            claimName: aurora-gateway-data
        - emptyDir: {}
          name: varlog
        - configMap:
            name: aurora-trusted-ca
          name: ca-bundle
      affinity:
    
        nodeAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
          - preference:
              matchExpressions:
              - key: topology.kubernetes.io/zone
                operator: In
                values:
                - iad-1a
                - iad-1b
            weight: 100
        podAntiAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchLabels:
                app.kubernetes.io/instance: aurora-gateway
                app.kubernetes.io/name: aurora-gateway
            topologyKey: kubernetes.io/hostname
      topologySpreadConstraints:
        - labelSelector:
            matchLabels:
              app.kubernetes.io/instance: aurora-gateway
          maxSkew: 1
          topologyKey: topology.kubernetes.io/zone
          whenUnsatisfiable: ScheduleAnyway
      nodeSelector:
        kubernetes.io/os: "linux"
        topology.kubernetes.io/zone: "iad-1a"
      tolerations:
        - effect: NoSchedule
          key: dedicated
          operator: Equal
          value: aurora
      priorityClassName: "system-cluster-critical"
      terminationGracePeriodSeconds: 45
      restartPolicy: Always
---
# Source: aurora-gateway/templates/app.yaml
apiVersion: batch/v1
kind: CronJob
metadata:
  name: aurora-gateway-cron
  namespace: aurora-gateway-ns
  labels:
    helm.sh/chart: aurora-gateway-0.5.2
    app.kubernetes.io/name: aurora-gateway
    app.kubernetes.io/instance: aurora-gateway
    app.kubernetes.io/version: "0.5.2"
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/managed-by: "platform-engineering"
    stack: "aurora"
spec:
  schedule: "*/15 * * * *"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 1
  startingDeadlineSeconds: 120
  suspend: false
  jobTemplate:
    spec:
      template:
        metadata:
          labels:
            app.kubernetes.io/name: aurora-gateway
            app.kubernetes.io/instance: aurora-gateway
            app.kubernetes.io/managed-by: "platform-engineering"
            stack: "aurora"
            jobType: "cache-warmer"
        spec:
          serviceAccountName: aurora-gateway
          restartPolicy: OnFailure
          imagePullSecrets:
            - name: ghcr-creds
          containers:
          - command:
            - /bin/sh
            - -c
            - ./aurora prime-cache
            env:
            - name: API_TOKEN
              valueFrom:
                secretKeyRef:
                  key: API_TOKEN
                  name: aurora-gateway-secret
            image: ghcr.io/caretak3r/aurora-tooling:0.12.0
            name: cache-warmer
---
# Source: aurora-gateway/templates/app.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: aurora-gateway
  namespace: aurora-gateway-ns
  labels:
    helm.sh/chart: aurora-gateway-0.5.2
    app.kubernetes.io/name: aurora-gateway
    app.kubernetes.io/instance: aurora-gateway
    app.kubernetes.io/version: "0.5.2"
    app.kubernetes.io/managed-by: Helm
  annotations:
    cert-manager.io/cluster-issuer: "aurora-issuer"
    maintainer: "sre@aurora.example"
    nginx.ingress.kubernetes.io/backend-protocol: "HTTP"
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
spec:
  ingressClassName: nginx
  rules:
    - host: "aurora.localdev.me"
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: aurora-gateway
                port:
                  number: 80
    - host: "api.aurora.localdev.me"
      http:
        paths:
          - path: /
            pathType: ImplementationSpecific
            backend:
              service:
                name: aurora-gateway
                port:
                  number: 80
  tls:
    - hosts:
      - aurora.localdev.me
      secretName: aurora-gateway-cert
---
# Source: aurora-gateway/templates/frontend.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: aurora-gateway-frontend-ingress
  labels:
    app.kubernetes.io/component: frontend
    app.kubernetes.io/instance: aurora-gateway
    app.kubernetes.io/name: aurora-gateway-frontend
  annotations:
    cert-manager.io/cluster-issuer: aurora-issuer
    nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
spec:
  ingressClassName: nginx
  rules:
    - host: "ui.aurora.localdev.me"
      http:
        paths:
          - path: /
            pathType: Prefix
            backend:
              service:
                name: aurora-gateway-frontend-svc
                port:
                  number: 80
  tls:
    - hosts:
        - "ui.aurora.localdev.me"
      secretName: aurora-frontend-cert
---
# Source: aurora-gateway/templates/app.yaml
apiVersion: security.istio.io/v1beta1
kind: AuthorizationPolicy
metadata:
  name: aurora-gateway-authz
  namespace: aurora-gateway-ns
  labels:
    helm.sh/chart: aurora-gateway-0.5.2
    app.kubernetes.io/name: aurora-gateway
    app.kubernetes.io/instance: aurora-gateway
    app.kubernetes.io/version: "0.5.2"
    app.kubernetes.io/managed-by: Helm
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: aurora-gateway
      app.kubernetes.io/instance: aurora-gateway
  action: ALLOW
  rules:
  - from:
    - source:
        principals: ["cluster.local/ns/*/sa/*"]
---
# Source: aurora-gateway/templates/app.yaml
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: aurora-gateway-tls
  namespace: aurora-gateway-ns
  labels:
    helm.sh/chart: aurora-gateway-0.5.2
    app.kubernetes.io/name: aurora-gateway
    app.kubernetes.io/instance: aurora-gateway
    app.kubernetes.io/version: "0.5.2"
    app.kubernetes.io/managed-by: Helm
spec:
  secretName: aurora-gateway-cert
  issuerRef:
    name: aurora-issuer
    kind: ClusterIssuer
  duration: 2160h
  renewBefore: 360h
  dnsNames:
    - "aurora.localdev.me"
    - "api.aurora.localdev.me"
  usages:
    - "server auth"
    - "client auth"
---
# Source: aurora-gateway/templates/app.yaml
apiVersion: security.istio.io/v1beta1
kind: PeerAuthentication
metadata:
  name: aurora-gateway
  namespace: aurora-gateway-ns
  labels:
    helm.sh/chart: aurora-gateway-0.5.2
    app.kubernetes.io/name: aurora-gateway
    app.kubernetes.io/instance: aurora-gateway
    app.kubernetes.io/version: "0.5.2"
    app.kubernetes.io/managed-by: Helm
spec:
  mtls:
    mode: STRICT
  selector:
    matchLabels:
      app.kubernetes.io/name: aurora-gateway
      app.kubernetes.io/instance: aurora-gateway
---
# Source: aurora-gateway/templates/app.yaml
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: aurora-gateway
  namespace: observability
  labels:
    helm.sh/chart: aurora-gateway-0.5.2
    app.kubernetes.io/name: aurora-gateway
    app.kubernetes.io/instance: aurora-gateway
    app.kubernetes.io/version: "0.5.2"
    app.kubernetes.io/managed-by: Helm
    release: "kube-prometheus-stack"
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: aurora-gateway
      app.kubernetes.io/instance: aurora-gateway
      app.kubernetes.io/managed-by: "platform-engineering"
      stack: "aurora"
  namespaceSelector:
    matchNames:
      - "aurora-gateway-ns"
  endpoints:
    - port: "http"
      path: "/metrics"
      interval: 30s
      scrapeTimeout: 10s
  jobLabel: aurora-gateway
---
# Source: aurora-gateway/templates/app.yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: aurora-gateway-preinstall
  namespace: aurora-gateway-ns
  labels:
    helm.sh/chart: aurora-gateway-0.5.2
    app.kubernetes.io/name: aurora-gateway
    app.kubernetes.io/instance: aurora-gateway
    app.kubernetes.io/version: "0.5.2"
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/managed-by: "platform-engineering"
    stack: "aurora"
  annotations:
    helm.sh/hook: pre-install,pre-upgrade
    helm.sh/hook-weight: "-5"
    helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded
spec:
  backoffLimit: 3
  completions: 1
  parallelism: 1
  activeDeadlineSeconds: 300
  template:
    metadata:
      labels:
        app.kubernetes.io/name: aurora-gateway
        app.kubernetes.io/instance: aurora-gateway
    spec:
      restartPolicy: Never
      serviceAccountName: aurora-gateway
      imagePullSecrets:
        - name: ghcr-creds
      containers:
        - name: aurora-gateway-preinstall
          image: ghcr.io/caretak3r/aurora-tooling:0.12.0
          imagePullPolicy: IfNotPresent
          command:
            - /bin/sh
            - /scripts/script.sh
          env:
            - name: DATABASE_URL
              valueFrom:
                secretKeyRef:
                  key: DATABASE_URL
                  name: aurora-gateway-secret
          volumeMounts:
            - mountPath: /tmp/job
              name: job-tmp
            - mountPath: /scripts
              name: job-script
              readOnly: true
          resources:
            limits:
              cpu: 500m
              memory: 512Mi
            requests:
              cpu: 100m
              memory: 128Mi
      volumes:
        - emptyDir: {}
          name: job-tmp
        - configMap:
            defaultMode: 365
            name: aurora-gateway-preinstall-script
          name: job-script
---
# Source: aurora-gateway/templates/app.yaml
apiVersion: batch/v1
kind: Job
metadata:
  name: aurora-gateway-postinstall
  namespace: aurora-gateway-ns
  labels:
    helm.sh/chart: aurora-gateway-0.5.2
    app.kubernetes.io/name: aurora-gateway
    app.kubernetes.io/instance: aurora-gateway
    app.kubernetes.io/version: "0.5.2"
    app.kubernetes.io/managed-by: Helm
    app.kubernetes.io/managed-by: "platform-engineering"
    stack: "aurora"
  annotations:
    helm.sh/hook: post-install,post-upgrade
    helm.sh/hook-weight: "5"
    helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded
spec:
  backoffLimit: 3
  completions: 1
  parallelism: 1
  activeDeadlineSeconds: 300
  template:
    metadata:
      labels:
        app.kubernetes.io/name: aurora-gateway
        app.kubernetes.io/instance: aurora-gateway
    spec:
      restartPolicy: Never
      serviceAccountName: aurora-gateway
      imagePullSecrets:
        - name: ghcr-creds
      containers:
        - name: aurora-gateway-postinstall
          image: ghcr.io/caretak3r/aurora-tooling:0.12.0
          imagePullPolicy: IfNotPresent
          command:
            - /bin/sh
            - /scripts/script.sh
          env:
            - name: SERVICE_URL
              value: http://aurora-gateway:8080/healthz
          volumeMounts:
            - mountPath: /tmp/job
              name: job-tmp
            - mountPath: /scripts
              name: job-script
              readOnly: true
          resources:
            limits:
              cpu: 500m
              memory: 512Mi
            requests:
              cpu: 100m
              memory: 128Mi
      volumes:
        - emptyDir: {}
          name: job-tmp
        - configMap:
            defaultMode: 365
            name: aurora-gateway-postinstall-script
          name: job-script
