# =============================================================================
# Service Configuration Template
# =============================================================================
# This file is the single source of truth for your service's Helm chart.
# Configure the sections below to enable/disable features for your application.
# Most features are disabled by default - enable only what you need.
# =============================================================================

# -----------------------------------------------------------------------------
serviceName: "aurora-gateway"
# name of the helm chart and service
# -----------------------------------------------------------------------------

# -----------------------------------------------------------------------------
# Platform specific
# -----------------------------------------------------------------------------
pipeline:
  libraryVersion: "1.0.0"
  # platform library chart version
  serviceVersion: "0.5.2"
  # service's version in the helm chart - will be used as the helm chart version as well 
  chartName: "aurora-gateway"
  # by default will be the serviceName - only change this when you have multiple services

# -----------------------------------------------------------------------------
# Naming Configuration
# -----------------------------------------------------------------------------
# Override auto-generated names if needed
nameOverride: ""
fullnameOverride: ""

# -----------------------------------------------------------------------------
# Global Configuration
# -----------------------------------------------------------------------------
# Shared settings that apply across all resources and subcharts
global:
  # Docker registry for all images (can be overridden per-image)
  imageRegistry: "ghcr.io/caretak3r"
  # Global image pull policy: Always, IfNotPresent, Never
  imagePullPolicy: IfNotPresent
  # Global image pull secrets (array of secret names)
  imagePullSecrets:
    - ghcr-creds
  # Global storage class for PVCs
  storageClass: fast-ssd

# -----------------------------------------------------------------------------
# Workload Type Selection
# -----------------------------------------------------------------------------
# Choose ONE workload type for your application
# Options: Deployment (default), StatefulSet, DaemonSet
workload:
  type: StatefulSet

# -----------------------------------------------------------------------------
# Container Image Configuration
# -----------------------------------------------------------------------------
image:
  registry: ghcr.io
  repository: caretakers/aurora-gateway
  tag: "1.3.7"
  digest: ""
  pullPolicy: Always
  pullSecrets:
    - ghcr-creds

# -----------------------------------------------------------------------------
# Replica Configuration
# -----------------------------------------------------------------------------
# Number of pod replicas (ignored when autoscaling is enabled)
replicaCount: 3
# Revision history limit for rollbacks
revisionHistoryLimit: 15

# -----------------------------------------------------------------------------
# Container Ports
# -----------------------------------------------------------------------------
# Ports exposed by the container
ports:
  - name: http
    containerPort: 8080
    protocol: TCP
  - name: grpc
    containerPort: 9090
    protocol: TCP

# -----------------------------------------------------------------------------
# Service Configuration
# -----------------------------------------------------------------------------
service:
  enabled: true
  type: LoadBalancer
  ports:
    - name: http
      port: 80
      targetPort: http
      protocol: TCP
    - name: grpc
      port: 9090
      targetPort: grpc
      protocol: TCP
  sessionAffinity: ClientIP
  sessionAffinityConfig:
    clientIP:
      timeoutSeconds: 10800
  clusterIP: ""
  loadBalancerIP: ""
  loadBalancerSourceRanges:
    - 10.0.0.0/24
  externalTrafficPolicy: Local
  annotations:
    service.beta.kubernetes.io/aws-load-balancer-type: nlb

# -----------------------------------------------------------------------------
# High Availability Configuration
# -----------------------------------------------------------------------------
highAvailability:
  enabled: true
  podAntiAffinityPreset: hard
  podAffinityPreset: ""
  nodeAffinityPreset:
    type: soft
    key: topology.kubernetes.io/zone
    values:
      - iad-1a
      - iad-1b
  topologySpreadConstraints:
    - maxSkew: 1
      topologyKey: topology.kubernetes.io/zone
      whenUnsatisfiable: ScheduleAnyway
      labelSelector:
        matchLabels:
          app.kubernetes.io/instance: aurora-gateway
  # Example:
  # topologySpreadConstraints:
  #   - maxSkew: 1
  #     topologyKey: topology.kubernetes.io/zone
  #     whenUnsatisfiable: DoNotSchedule
  #     labelSelector:
  #       matchLabels:
  #         app.kubernetes.io/instance: myapp

# -----------------------------------------------------------------------------
# Horizontal Pod Autoscaler
# -----------------------------------------------------------------------------
autoscaling:
  enabled: true
  minReplicas: 3
  maxReplicas: 9
  targetCPU: 65
  targetMemory: 70
  metrics: []
  behavior:
    scaleDown:
      stabilizationWindowSeconds: 300
      policies:
        - type: Percent
          value: 20
          periodSeconds: 60
    scaleUp:
      stabilizationWindowSeconds: 0
      policies:
        - type: Percent
          value: 100
          periodSeconds: 30
  # Example:
  # behavior:
  #   scaleDown:
  #     stabilizationWindowSeconds: 300
  #     policies:
  #       - type: Percent
  #         value: 10
  #         periodSeconds: 60
  #   scaleUp:
  #     stabilizationWindowSeconds: 0
  #     policies:
  #       - type: Percent
  #         value: 100
  #         periodSeconds: 15

# -----------------------------------------------------------------------------
# Update Strategy
# -----------------------------------------------------------------------------
updateStrategy:
  type: RollingUpdate
  rollingUpdate:
    maxSurge: 0
    maxUnavailable: 1

# -----------------------------------------------------------------------------
# Pod Disruption Budget
# -----------------------------------------------------------------------------
podDisruptionBudget:
  enabled: true
  minAvailable: 2

# -----------------------------------------------------------------------------
# Resource Configuration
# -----------------------------------------------------------------------------
resources:
  requests:
    cpu: 500m
    memory: 1Gi
  limits:
    cpu: 1500m
    memory: 3Gi
# Example:
# resources:
#   requests:
#     cpu: 100m
#     memory: 128Mi
#   limits:
#     cpu: 500m
#     memory: 512Mi

# -----------------------------------------------------------------------------
# Probes Configuration
# -----------------------------------------------------------------------------
# Startup Probe - delays other probes until startup succeeds
startupProbe:
  enabled: true
  # httpGet, tcpSocket, exec, or grpc
  httpGet:
    path: /healthz
    port: http
  initialDelaySeconds: 0
  periodSeconds: 10
  timeoutSeconds: 1
  failureThreshold: 30
  successThreshold: 1

# Liveness Probe - restarts container if fails
livenessProbe:
  enabled: true
  httpGet:
    path: /healthz
    port: http
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3
  successThreshold: 1

# Readiness Probe - removes from service if fails
readinessProbe:
  enabled: true
  httpGet:
    path: /ready
    port: http
  initialDelaySeconds: 10
  periodSeconds: 5
  timeoutSeconds: 3
  failureThreshold: 3
  successThreshold: 1

# -----------------------------------------------------------------------------
# Init Containers
# -----------------------------------------------------------------------------
initContainers:
  enabled: true
  containers:
    - name: init-schema
      image: busybox:1.36
      command:
        - /bin/sh
        - -c
        - >-
          until nc -z aurora-postgres 5432; do echo "waiting for db"; sleep 3; done;
          echo "db ready";
      resources:
        requests:
          cpu: 30m
          memory: 64Mi
  # Example:
  # containers:
  #   - name: init-db
  #     image: busybox:1.35
  #     command: ['sh', '-c', 'until nc -z db 5432; do sleep 1; done']
  #     resources:
  #       requests:
  #         cpu: 10m
  #         memory: 32Mi

# -----------------------------------------------------------------------------
# Sidecar Containers
# -----------------------------------------------------------------------------
sidecars:
  enabled: true
  containers:
    - name: vector-agent
      image: timberio/vector:0.40.0-debian
      args: ["--config=/etc/vector/vector.toml"]
      volumeMounts:
        - name: varlog
          mountPath: /var/log/app
      resources:
        requests:
          cpu: 50m
          memory: 128Mi
  # Example:
  # containers:
  #   - name: log-collector
  #     image: fluent/fluent-bit:2.0
  #     volumeMounts:
  #       - name: varlog
  #         mountPath: /var/log
  #     resources:
  #       requests:
  #         cpu: 50m
  #         memory: 64Mi

# -----------------------------------------------------------------------------
# ConfigMap Configuration
# -----------------------------------------------------------------------------
configMap:
  enabled: true
  mounted: true
  mountPath: /app/config
  subPath: "application.yaml"
  data:
    application.yaml: |
      server:
        port: 8080
      features:
        asyncPipeline: true
        betaBanner: false
    FEATURE_FLAG_ROLLOUT: "canary"
  # Example:
  # data:
  #   config.yaml: |
  #     server:
  #       port: 8080
  #   LOG_LEVEL: info
  annotations: {}
  labels: {}

# -----------------------------------------------------------------------------
# Secret Configuration
# -----------------------------------------------------------------------------
secret:
  enabled: true
  type: Opaque
  data: {}
  stringData:
    DB_PASSWORD: "super-secret-password"
    API_TOKEN: "dev-token"
    DATABASE_URL: "postgresql://aurora:aurora@aurora-postgres:5432/aurora"
  annotations: {}
  labels: {}

# -----------------------------------------------------------------------------
# Environment Variables
# -----------------------------------------------------------------------------
# Direct environment variables
envVars:
  LOG_LEVEL: info
  FEATURE_FLAG: blueGreen
  CACHE_ENDPOINT:
    valueFrom:
      secretKeyRef:
        name: aurora-cache
        key: endpoint
# Example:
# envVars:
#   LOG_LEVEL: info
#   DATABASE_HOST: db.example.com
#   API_KEY:
#     valueFrom:
#       secretKeyRef:
#         name: api-secrets
#         key: api-key

# ConfigMap reference for env vars
envVarsConfigMap: aurora-gateway-config
# Secret reference for env vars
envVarsSecret: aurora-gateway-secret

# -----------------------------------------------------------------------------
# Ingress Configuration
# -----------------------------------------------------------------------------
ingress:
  enabled: true
  ingressClassName: nginx
  hostname: aurora.localdev.me
  path: /
  pathType: Prefix
  annotations:
    cert-manager.io/cluster-issuer: aurora-issuer
    nginx.ingress.kubernetes.io/ssl-redirect: "true"
    nginx.ingress.kubernetes.io/backend-protocol: "HTTP"
  tls: true
  existingSecret: aurora-gateway-cert
  selfSigned: false
  extraHosts:
    - name: api.aurora.localdev.me
      path: /
  # Example:
  # extraHosts:
  #   - name: api.example.com
  #     path: /
  extraPaths: []
  extraTls: []
  extraRules: []
  # Provide your own certificates
  secrets: []

# -----------------------------------------------------------------------------
# Frontend Experience Deployment
# -----------------------------------------------------------------------------
frontend:
  enabled: true
  replicaCount: 3
  annotations:
    rollout/version: "blue"
  podAnnotations:
    prometheus.io/scrape: "true"
    prometheus.io/port: "4173"
  podLabels:
    tier: presentation
  image:
    repository: ghcr.io/caretak3r/aurora-frontend
    tag: "2.4.1"
    pullPolicy: IfNotPresent
  containerPort: 4173
  env:
    - name: API_BASE_URL
      value: https://aurora.localdev.me/api
    - name: FEATURE_TOGGLE
      value: neon
  resources:
    requests:
      cpu: 250m
      memory: 512Mi
    limits:
      cpu: 500m
      memory: 1Gi
  nodeSelector:
    kubernetes.io/os: linux
  tolerations:
    - key: dedicated
      operator: Equal
      value: frontend
      effect: NoSchedule
  affinity: {}
  serviceAccountName: ""
  service:
    enabled: true
    type: ClusterIP
    annotations:
      cloud.google.com/backend-config: '{"default":"aurora-frontend"}'
    ports:
      - name: web
        port: 80
        targetPort: web
        protocol: TCP
  ingress:
    enabled: true
    classname: nginx
    hostname: ui.aurora.localdev.me
    path: /
    pathType: Prefix
    annotations:
      cert-manager.io/cluster-issuer: aurora-issuer
      nginx.ingress.kubernetes.io/force-ssl-redirect: "true"
    tls:
      enabled: true
      secretName: aurora-frontend-cert

# -----------------------------------------------------------------------------
# Certificate Management (cert-manager)
# -----------------------------------------------------------------------------
certificate:
  enabled: true
  issuer: aurora-issuer
  secretName: aurora-gateway-cert
  duration: 2160h
  renewBefore: 360h
  dnsNames:
    - aurora.localdev.me
    - api.aurora.localdev.me
  ipAddresses: []
  usages:
    - server auth
    - client auth

# -----------------------------------------------------------------------------
# TLS / Self-Signed Certificate Generation
# -----------------------------------------------------------------------------
# Generate self-signed TLS certificates
tlsSelfSigned:
  enabled: false
  commonName: ""
  dnsNames: []
  validityDays: 365

# -----------------------------------------------------------------------------
# mTLS Configuration
# -----------------------------------------------------------------------------
mtls:
  enabled: true
  policy: STRICT

# -----------------------------------------------------------------------------
# Jobs Configuration (Pre-install / Post-install Helm Hooks)
# -----------------------------------------------------------------------------
jobs:
  # Common settings for all jobs
  image:
    repository: ghcr.io/caretak3r/aurora-tooling
    tag: "0.12.0"
    pullPolicy: IfNotPresent
  backoffLimit: 3
  completions: 1
  parallelism: 1
  restartPolicy: Never
  activeDeadlineSeconds: 300
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 512Mi

  # Pre-install job (runs before main deployment)
  preInstall:
    enabled: true
    hookWeight: -5
    script: |
      echo "running schema migrations"
      ./aurora migrate --database $DATABASE_URL
    # Or reference a script file
    scriptFile: ""
    # Or custom command/args
    command: []
    args: []
    env:
      - name: DATABASE_URL
        valueFrom:
          secretKeyRef:
            name: aurora-gateway-secret
            key: DATABASE_URL
    volumeMounts:
      - name: job-tmp
        mountPath: /tmp/job
    volumes:
      - name: job-tmp
        emptyDir: {}
    # Override common job settings
    # image: {}
    # resources: {}

  # Post-install job (runs after main deployment)
  postInstall:
    enabled: true
    hookWeight: 5
    script: |
      echo "triggering smoke test"
      ./aurora smoke-test --endpoint $SERVICE_URL
    scriptFile: ""
    command: []
    args: []
    env:
      - name: SERVICE_URL
        value: http://aurora-gateway:8080/healthz
    volumeMounts:
      - name: job-tmp
        mountPath: /tmp/job
    volumes:
      - name: job-tmp
        emptyDir: {}

# -----------------------------------------------------------------------------
# CronJob Configuration
# -----------------------------------------------------------------------------
cronJob:
  enabled: true
  schedule: "*/15 * * * *"
  concurrencyPolicy: Forbid
  successfulJobsHistoryLimit: 3
  failedJobsHistoryLimit: 1
  startingDeadlineSeconds: 120
  suspend: false
  containers:
    - name: cache-warmer
      image: ghcr.io/caretak3r/aurora-tooling:0.12.0
      command:
        - /bin/sh
        - -c
        - ./aurora prime-cache
      env:
        - name: API_TOKEN
          valueFrom:
            secretKeyRef:
              name: aurora-gateway-secret
              key: API_TOKEN
  initContainers: []
  volumes: []
  annotations: {}
  podAnnotations: {}
  podLabels:
    jobType: cache-warmer
  nodeSelector: {}
  tolerations: []

# -----------------------------------------------------------------------------
# Persistence / Storage
# -----------------------------------------------------------------------------
persistence:
  enabled: true
  mountPath: /var/lib/aurora
  subPath: ""
  storageClass: fast-ssd
  accessModes:
    - ReadWriteOnce
  size: 50Gi
  existingClaim: ""
  selector: {}
  dataSource: {}
  annotations:
    snapshot.storage.kubernetes.io/retain: "true"

# -----------------------------------------------------------------------------
# StatefulSet Specific Configuration
# -----------------------------------------------------------------------------
statefulSet:
  # Service name for stable network identities
  serviceName: aurora-gateway-headless
  # Pod management policy: OrderedReady, Parallel
  podManagementPolicy: OrderedReady
  updateStrategy:
    type: RollingUpdate
    rollingUpdate:
      partition: 0
  # Volume claim templates for StatefulSet
  volumeClaimTemplates: []
  # Example:
  # volumeClaimTemplates:
  #   - name: data
  #     storageClassName: fast-ssd
  #     accessModes: [ReadWriteOnce]
  #     storage: 10Gi

# -----------------------------------------------------------------------------
# DaemonSet Specific Configuration
# -----------------------------------------------------------------------------
daemonSet:
  updateStrategy:
    type: RollingUpdate
    rollingUpdate:
      maxUnavailable: 1
  # DaemonSets often need specific node selectors
  nodeSelector: {}
  # Example:
  # nodeSelector:
  #   kubernetes.io/os: linux

# -----------------------------------------------------------------------------
# Service Account Configuration
# -----------------------------------------------------------------------------
serviceAccount:
  create: true
  name: ""
  automountServiceAccountToken: true
  annotations:
    eks.amazonaws.com/role-arn: arn:aws:iam::123456789012:role/aurora-gateway
  # Example for AWS IAM roles:
  # annotations:
  #   eks.amazonaws.com/role-arn: arn:aws:iam::123456789:role/myapp
  labels: {}

# -----------------------------------------------------------------------------
# Security Context
# -----------------------------------------------------------------------------
# Pod-level security context
podSecurityContext:
  enabled: true
  fsGroup: 2000
  # runAsUser: 1001
  # runAsGroup: 1001
  # runAsNonRoot: true
  # seccompProfile:
  #   type: RuntimeDefault

# Container-level security context
containerSecurityContext:
  enabled: true
  runAsUser: 2000
  runAsNonRoot: true
  readOnlyRootFilesystem: true
  allowPrivilegeEscalation: false
  capabilities:
    drop:
      - ALL

# -----------------------------------------------------------------------------
# Pod Scheduling
# -----------------------------------------------------------------------------
# Node selector
nodeSelector:
  kubernetes.io/os: linux
  topology.kubernetes.io/zone: iad-1a

# Tolerations
tolerations:
  - key: dedicated
    operator: Equal
    value: aurora
    effect: NoSchedule

# Affinity (overrides HA presets if set)
affinity: {}

# Priority class name
priorityClassName: system-cluster-critical

# Scheduler name
schedulerName: ""

# Termination grace period
terminationGracePeriodSeconds: 45

# Pod restart policy (for non-controller pods)
podRestartPolicy: Always

# Host aliases (/etc/hosts entries)
hostAliases: []

# -----------------------------------------------------------------------------
# Volumes
# -----------------------------------------------------------------------------
extraVolumes:
  - name: varlog
    emptyDir: {}
  - name: ca-bundle
    configMap:
      name: aurora-trusted-ca
# Example:
# extraVolumes:
#   - name: config-vol
#     configMap:
#       name: my-config
#   - name: secret-vol
#     secret:
#       secretName: my-secret

extraVolumeMounts:
  - name: ca-bundle
    mountPath: /etc/ssl/certs/custom
    readOnly: true
# Example:
# extraVolumeMounts:
#   - name: config-vol
#     mountPath: /etc/config
#     readOnly: true

# -----------------------------------------------------------------------------
# Command and Args Override
# -----------------------------------------------------------------------------
command:
  - /bin/aurora-gateway
args:
  - --config=/app/config/application.yaml
  - --enable-ingress-proxy

# -----------------------------------------------------------------------------
# Lifecycle Hooks
# -----------------------------------------------------------------------------
lifecycleHooks:
  preStop:
    exec:
      command:
        - /bin/sh
        - -c
        - sleep 5 && curl -X POST localhost:8080/shutdown
# Example:
# lifecycleHooks:
#   postStart:
#     exec:
#       command: ["/bin/sh", "-c", "echo Hello"]
#   preStop:
#     httpGet:
#       path: /shutdown
#       port: 8080

# -----------------------------------------------------------------------------
# Service Monitor (Prometheus Operator)
# -----------------------------------------------------------------------------
serviceMonitor:
  enabled: true
  namespace: observability
  port: http
  path: /metrics
  interval: 30s
  scrapeTimeout: 10s
  labels:
    release: kube-prometheus-stack
  annotations: {}
  jobLabel: aurora-gateway
  honorLabels: false
  relabelings: []
  metricRelabelings: []
  selector: {}
  namespaceSelector: {}

# -----------------------------------------------------------------------------
# Pod Monitor (Prometheus Operator)
# -----------------------------------------------------------------------------
podMonitor:
  enabled: false
  namespace: ""
  port: http
  path: /metrics
  interval: 30s
  scrapeTimeout: 10s
  labels: {}
  annotations: {}
  jobLabel: ""
  honorLabels: false
  relabelings: []
  metricRelabelings: []
  selector: {}
  namespaceSelector: {}

# -----------------------------------------------------------------------------
# Network Policy
# -----------------------------------------------------------------------------
networkPolicy:
  enabled: true
  policyTypes:
    - Ingress
    - Egress
  podSelector: {}
  ingress:
    - from:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: ingress-nginx
      ports:
        - port: 8080
          protocol: TCP
  # Example:
  # ingress:
  #   - from:
  #       - namespaceSelector:
  #           matchLabels:
  #             name: ingress-nginx
  #     ports:
  #       - port: 8080
  # Egress rules
  egress:
    - to:
        - namespaceSelector:
            matchLabels:
              kubernetes.io/metadata.name: kube-system
      ports:
        - port: 443
          protocol: TCP

# -----------------------------------------------------------------------------
# Labels and Annotations
# -----------------------------------------------------------------------------
# Labels applied to all resources
commonLabels:
  app.kubernetes.io/managed-by: platform-engineering
  stack: aurora

# Annotations applied to all resources
commonAnnotations:
  maintainer: sre@aurora.example

# Labels for the workload (Deployment/StatefulSet/DaemonSet)
labels:
  workload: gateway

# Annotations for the workload
annotations:
  reloader.stakater.com/auto: "true"

# Labels for pods only
podLabels:
  trace-enabled: "true"

# Annotations for pods only
podAnnotations:
  sidecar.istio.io/inject: "true"
